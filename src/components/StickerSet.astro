---
import fs from 'node:fs';
import path from 'node:path';
import languageData from '../data/languages.json';
import wordTranslations from '../data/word-translations.json';

interface StickerItem {
  id: string;
  label: string;
}

interface Props {
  variant?: 'rail' | 'cluster';
  stickers: StickerItem[];
  class?: string;
}

const { variant = 'rail', stickers, class: className = '' } = Astro.props;
const languages = languageData.languages;
const projectRoot = process.cwd();
const illustrationsDir = path.join(projectRoot, 'public', 'illustrations');

const defaultLanguage = wordTranslations.defaultLanguage ?? 'en';

function getIllustrationExt(id: string) {
  const png = path.join(illustrationsDir, `${id}.png`);
  return fs.existsSync(png) ? 'png' : 'svg';
}

function getTranslations(wordId: string) {
  const wordEntry = wordTranslations.words?.[wordId] ?? {};
  const fallback = wordEntry[defaultLanguage] ?? wordEntry.en ?? wordId;

  return languages.map((language) => ({
    language: language.nativeName || language.name,
    languageSlug: language.slug,
    word: wordEntry[language.slug] ?? fallback,
  }));
}
---

<div class:list={['sticker-set', `sticker-set--${variant}`, className]}>
  {stickers.map((sticker) => (
    <div
      class="sticker-set__item"
      data-sticker
      data-auto-rotate={variant === 'rail' ? 'true' : 'false'}
      data-word={sticker.id}
      data-translations={JSON.stringify(getTranslations(sticker.id))}
      tabindex="0"
      aria-label={`${sticker.label} sticker`}
    >
      <img
        src={`/illustrations/${sticker.id}.${getIllustrationExt(sticker.id)}`}
        alt={sticker.label}
        loading="lazy"
        decoding="async"
        class="sticker-set__img"
      />
      <span class="sticker-set__tooltip" data-sticker-label>
        {sticker.label}
      </span>
    </div>
  ))}
</div>

<style>
  .sticker-set {
    display: flex;
    gap: var(--space-5);
    flex-wrap: wrap;
    justify-content: center;
  }

  .sticker-set--rail {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: var(--space-5) var(--space-3);
    padding: var(--space-8) 0 var(--space-10);
    align-items: start;
  }

  .sticker-set--cluster {
    justify-content: flex-end;
    gap: var(--space-3);
  }

  .sticker-set__item {
    position: relative;
    width: 72px;
    height: 72px;
    display: grid;
    place-items: center;
    opacity: 0.9;
    transition: transform var(--transition-fast), opacity var(--transition-fast);
  }

  .sticker-set--rail .sticker-set__item {
    width: auto;
    height: auto;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    align-items: center;
    justify-content: flex-start;
  }

  .sticker-set__item:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 4px;
    border-radius: var(--radius-md);
  }

  .sticker-set__img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    position: relative;
    top: 0;
    transition: top var(--transition-fast), filter var(--transition-fast);
    animation: sticker-float 12s ease-in-out infinite;
  }

  .sticker-set__item:nth-child(2n) .sticker-set__img {
    animation-duration: 14s;
  }

  .sticker-set__item:nth-child(3n) .sticker-set__img {
    animation-duration: 16s;
  }

  .sticker-set__item:hover,
  .sticker-set__item:focus-visible {
    transform: translateY(-4px);
    opacity: 1;
  }

  .sticker-set__tooltip {
    position: absolute;
    bottom: -18px;
    left: 50%;
    transform: translate(-50%, 6px);
    background: rgba(255, 255, 255, 0.92);
    color: var(--color-text);
    border-radius: var(--radius-full);
    padding: 2px 10px;
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    box-shadow: var(--shadow-sm);
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--transition-fast), transform var(--transition-fast);
  }

  .sticker-set__item:hover .sticker-set__tooltip,
  .sticker-set__item:focus-visible .sticker-set__tooltip {
    opacity: 1;
    transform: translate(-50%, 0);
  }

  .sticker-set--rail .sticker-set__tooltip {
    position: static;
    opacity: 1;
    transform: none;
    white-space: normal;
    text-align: center;
    line-height: 1.25;
    min-height: 2.8em;
    width: 100%;
    max-width: 150px;
    pointer-events: auto;
  }

  .sticker-set--rail .sticker-set__item:hover,
  .sticker-set--rail .sticker-set__item:focus-visible {
    transform: none;
  }

  .sticker-set--rail .sticker-set__item:hover .sticker-set__img,
  .sticker-set--rail .sticker-set__item:focus-visible .sticker-set__img {
    top: -3px;
    filter: drop-shadow(0 5px 8px rgba(0, 0, 0, 0.12));
  }

  .sticker-set--rail .sticker-set__item:hover .sticker-set__tooltip,
  .sticker-set--rail .sticker-set__item:focus-visible .sticker-set__tooltip {
    transform: none;
  }

  .sticker-set--rail .sticker-set__img {
    width: 72px;
    height: 72px;
  }

  @keyframes sticker-float {
    0%,
    100% {
      transform: translateY(0) rotate(-1deg);
    }
    50% {
      transform: translateY(-6px) rotate(1deg);
    }
  }

  @media (max-width: 768px) {
    .sticker-set__item {
      width: 60px;
      height: 60px;
    }

    .sticker-set--rail {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--space-4) var(--space-2);
    }

    .sticker-set--rail .sticker-set__item {
      width: auto;
      height: auto;
      gap: var(--space-2);
    }

    .sticker-set--rail .sticker-set__img {
      width: 56px;
      height: 56px;
    }

    .sticker-set__tooltip {
      font-size: 0.65rem;
    }
  }
  
  @media (prefers-reduced-motion: reduce) {
    .sticker-set__img {
      animation: none;
    }
  }
</style>

<script>
  const stickerItems = document.querySelectorAll('[data-sticker]');

  const shuffle = (list) => {
    const array = [...list];
    for (let i = array.length - 1; i > 0; i -= 1) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  };

  const buildOrder = (translations, previousLanguage) => {
    if (!translations.length) {
      return [];
    }

    const shuffled = shuffle(translations);
    if (previousLanguage && shuffled.length > 1 && shuffled[0].language === previousLanguage) {
      [shuffled[0], shuffled[1]] = [shuffled[1], shuffled[0]];
    }
    return shuffled;
  };

  stickerItems.forEach((item) => {
    const label = item.querySelector('[data-sticker-label]');
    const translationsRaw = item.getAttribute('data-translations');
    const autoRotate = item.getAttribute('data-auto-rotate') === 'true';
    if (!translationsRaw || !label) return;

    const translations = JSON.parse(translationsRaw);
    if (!Array.isArray(translations) || translations.length === 0) return;

    let order = buildOrder(translations);
    let index = 0;
    let lastLanguage = order[0]?.language;
    let intervalId = null;

    const applyLabel = (entry) => {
      if (!entry) return;
      label.textContent = `${entry.word} Â· ${entry.language}`;
      item.setAttribute('data-language', entry.languageSlug || '');
    };

    applyLabel(order[0]);

    const nextEntry = () => {
      index += 1;
      if (index >= order.length) {
        lastLanguage = order[order.length - 1]?.language;
        order = buildOrder(translations, lastLanguage);
        index = 0;
      }
      applyLabel(order[index]);
    };

    const startRotation = () => {
      if (intervalId || translations.length < 2) return;
      intervalId = window.setInterval(nextEntry, 1200);
    };

    const stopRotation = () => {
      if (!intervalId) return;
      window.clearInterval(intervalId);
      intervalId = null;
    };

    if (autoRotate) {
      startRotation();
      return;
    }

    item.addEventListener('mouseenter', startRotation);
    item.addEventListener('focusin', startRotation);
    item.addEventListener('mouseleave', stopRotation);
    item.addEventListener('focusout', stopRotation);
  });
</script>
